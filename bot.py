from telebot import TeleBot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, Message
from keyboard import menu, helpkey, travelhelp
import random
from secret import TOKEN
from config import (MAX_GPT_TOKENS, MAX_USER_GPT_TOKENS, MAX_USERS)
from database import Database
from yandexgpt import ask_gpt
bot = TeleBot(TOKEN)
db = Database()
#######################################################DatabaseFunction#########################################################
def check_number_of_users(chat_id):
    count = db.count_users(chat_id)
    if count is None:
        return None, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î"
    if count > MAX_USERS:
        return None, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    return True, ""


######################################################MainFunctions#########################################################

@bot.message_handler(commands=['start'])
def start(message):
    chat_id = message.chat.id
    user_name = message.from_user.first_name
    db.add_user(chat_id)
    bot.send_message(chat_id,
                     f"<b>–ü—Ä–∏–≤–µ—Ç {user_name}üëã, —ç—Ç–æ –±–æ—Ç –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö.</b>\n\n"
                     f"–î–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å /help.\n"
                     f"–ê –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º –ø–æ –≤–∞—à–µ–º—É –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—é –Ω–∞–ø–∏—à–∏—Ç–µ /set_town –∏ —É–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥.\n",
                     parse_mode='html',reply_markup=helpkey)

@bot.message_handler(commands=['help'])
def help(message):
    chat_id = message.chat.id
    user_name = message.from_user.first_name

    bot.send_message(chat_id,
                     f"–î–∞–Ω–Ω—ã–π –±–æ—Ç ü§ñ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ <b>YaGPT</b>.\n\n"
                     f" /support_of_—Åreators - –∫–æ–º–∞–Ω–¥–∞, –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞—Ç–µ–ª—è—Ö –±–æ—Ç–∞.\n"
                     f" /interesting_facts - 10 –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –æ —Å—Ç—Ä–∞–Ω–µ.\n"
                     f" /travel_help - –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö –≥–æ—Ä–æ–¥–∞.\n"
                     f" /town_history - —É–∑–Ω–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≥–æ—Ä–æ–¥–∞\n"
                     f" /set_town - –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –≤–∞–º –≥–æ—Ä–æ–¥–∞, –±–µ–∑ –Ω–µ—ë –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã.\n"
                     f" /set_country - –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–π –≤–∞—Å —Å—Ç—Ä–∞–Ω—ã, –±–µ–∑ –Ω–µ—ë –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã.\n"   
                     f"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞ - {MAX_USERS}\n"
                     f"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - {MAX_USER_GPT_TOKENS}\n"
                     f"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ GPT - {MAX_GPT_TOKENS}\n",
                     parse_mode='html', reply_markup=helpkey)

@bot.message_handler(commands=['support_of_—Åreators'])
def support_of_—Åreators(message):
    chat_id = message.chat.id
    user_name = message.from_user.first_name

    bot.send_message(chat_id,
                     f"<b>–≠—Ç–∏ –ª—é–¥–∏üßëüèº‚Äçüíª —Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–∞–¥ –±–æ—Ç–æ–º, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–º–æ—â—å, –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–º—É-—Ç–æ –∏–∑ –Ω–∏—Ö:</b>\n\n"
                     f"üë®‚Äçüéì<b>–ú–∞—Ä–∫</b>\n"
                     f"Discord - <code>lathanael.</code>\n"
                     f"Telegram - @Ts_Mark1\n"
                     f"üë®‚Äçüéì<b>–ê–ª–µ–∫—Å–µ–π</b>\n"
                     f"Discord - <code>noverega10</code>\n"
                     f"Telegram - @noverega\n"
                     f"ü•∑<b>–õ–µ–æ–Ω–∏–¥</b>\n"
                     f"Discord - <code>fallan.</code>\n"
                     f"Telegram - <code>@fallangg</code>\n",
                     parse_mode='html',reply_markup=menu)

@bot.message_handler(commands=['menu'])
def menu(message):
    bot.send_message(message.chat.id, '–ü–µ—Ä–µ–≤–æ–∂—É –≤ –º–µ–Ω—é...', reply_markup=helpkey)


#####################################################GetParamsModule##########################################################

@bot.message_handler(commands=['set_town'])
def get_town(message):
    chat_id = message.chat.id
    bot.send_message(chat_id, '–ù–∞–ø–∏—à–∏ <b>–≥–æ—Ä–æ–¥</b>, –æ –∫–æ—Ç–æ—Ä–æ–º –º—ã –±—É–¥–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º..',
                     parse_mode='html',reply_markup=menu)
    bot.register_next_step_handler(message, handle_message)

@bot.message_handler(commands=['set_country'])
def start_country(message):
    chat_id = message.chat.id
    bot.send_message(chat_id, '–ù–∞–ø–∏—à–∏ <b>–∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —Å—Ç—Ä–∞–Ω—É</b>, –æ –∫–æ—Ç–æ—Ä–æ–º –º—ã –±—É–¥–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º..',
                     parse_mode='html', reply_markup=menu)
    bot.register_next_step_handler(message, handle_message)


####################################################GenerationModule###########################################################
@bot.message_handler(commands=['city_restaurants'])
def city_restaurants(message):
    chat_id = message.chat.id

    status_check_users, error_message = check_number_of_users(chat_id)
    if not status_check_users:
        bot.send_message(chat_id, error_message)
        return

    city = db.get_city(chat_id)
    if city == None:
        bot.send_message(chat_id, "<b>–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –≥–æ—Ä–æ–¥, –Ω–∞–ø–∏—à–∏—Ç–µ /set_town!</b>üò•\n",
                         parse_mode='html', reply_markup=menu)
        return
    bot.send_message(chat_id, f'–í—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥: {city}.\n –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è...')

    PROMPT = [{'role': 'system',
               'text': f'–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –≤ –≥–æ—Ä–æ–¥–µ {city}, –†–∞—Å—Å–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ —á–µ–º –≤ 1000 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–µ–±–µ –Ω—É–∂–Ω–æ —É–ª–æ–∂–∏—Ç—å—Å—è –≤ 1000 —Å–∏–º–≤–æ–ª–æ–≤. –í –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞–π –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–æ–π –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–µ–±—è.'}]
    user_tokens = db.get_tokens(chat_id)
    if user_tokens < 200:
        bot.send_message(chat_id, "<b>–£ –≤–∞—Å –Ω–µ—Ç—É —Ç–æ–∫–µ–Ω–æ–≤.</b>üò•\n"
                                  "–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã: /help, /get_weather –∏ /support_of_—Åreators",
                         parse_mode='html', reply_markup=menu)
        return
    success, otvet, tokens_in_answer = ask_gpt(PROMPT)
    if success:
        bot.send_message(chat_id, f"<b>{otvet}</b>",
                         parse_mode='html', reply_markup=helpkey)
        db.update_history(otvet, chat_id)
        db.update_tokens(tokens_in_answer, chat_id)
@bot.message_handler(commands=['interesting_facts'])
def facts(message):
    chat_id = message.chat.id

    status_check_users, error_message = check_number_of_users(chat_id)
    if not status_check_users:
        bot.send_message(chat_id, error_message)
        return

    score = db.get_score(chat_id)
    if score < 2:
        bot.send_message(chat_id, '–ö–∞–∫ –≤—ã –ø–æ–º–Ω–∏—Ç–µ, —É —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –µ—Å—Ç—å –æ–ø–ª–∞—Ç–∞ - 2 –ë–∞–ª–ª–∞, \n'
                                  f'–ö–æ–ª-–≤–æ –±–∞–ª–ª–æ–≤: {score}'
                                  f'–ß—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–∞–ª–ª—ã –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ  –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ö–æ—Ç—è –±—ã 1 —Ä–∞–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –Ω–∞–∂–º–∏—Ç–µ /travel_quiz', reply_markup=helpkey)
        return
    country = db.get_country(chat_id)
    if country == None:
        bot.send_message(chat_id, "<b>–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —Å—Ç—Ä–∞–Ω—É, –Ω–∞–ø–∏—à–∏—Ç–µ /set_country!</b>üò•\n",
                         parse_mode='html', reply_markup=menu)
        return
    bot.send_message(chat_id, f'–í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞: {country}.\n –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤...')

    PROMPT = [{'role': 'system',
               'text': f'–†–∞—Å—Å–∫–∞–∂–∏ 10 —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –ø—Ä–æ —Å—Ç—Ä–∞–Ω—É {country}, –Ω–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–æ–π –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–µ–±—è.'}]
    user_tokens = db.get_tokens(chat_id)
    if user_tokens < 200:
        bot.send_message(chat_id, "<b>–£ –≤–∞—Å –Ω–µ—Ç—É —Ç–æ–∫–µ–Ω–æ–≤.</b>üò•\n"
                                  "–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã: /help, /get_weather –∏ /support_of_—Åreators, /travel_quiz",
                         parse_mode='html', reply_markup=menu)
        return
    success, otvet, tokens_in_answer = ask_gpt(PROMPT)
    if success:
        bot.send_message(chat_id, f"<b>{otvet}</b>",
                         parse_mode='html', reply_markup=helpkey)
        db.update_tokens(tokens_in_answer, chat_id)
@bot.message_handler(commands=['town_history'])
def city_history(message):
    chat_id = message.chat.id

    status_check_users, error_message = check_number_of_users(chat_id)
    if not status_check_users:
        bot.send_message(chat_id, error_message)
        return

    city = db.get_city(chat_id)
    if city == None:
        bot.send_message(chat_id, "<b>–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –≥–æ—Ä–æ–¥, –Ω–∞–ø–∏—à–∏—Ç–µ /set_town!</b>üò•\n",
                     parse_mode='html',reply_markup=menu)
        return
    bot.send_message(chat_id, f'–í—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥: {city}.\n –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏...')

    PROMPT = [{'role': 'system', 'text': f'–†–∞—Å—Å–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –≥–æ—Ä–æ–¥–∞ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º {city}. –ù–∞–ø–∏—à–∏ —ç—Ç–æ—Ç —Ä–∞—Å—Å–∫–∞–∑ –Ω–µ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 1000 —Å–∏–º–≤–æ–ª–æ–≤. –í –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞–π –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–æ–π –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–µ–±—è.'}]
    user_tokens = db.get_tokens(chat_id)
    if user_tokens < 200:
        bot.send_message(chat_id, "<b>–£ –≤–∞—Å –Ω–µ—Ç—É —Ç–æ–∫–µ–Ω–æ–≤.</b>üò•\n"
                                  "–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã: /help, /get_weather –∏ /support_of_—Åreators",
                     parse_mode='html',reply_markup=menu)
        return
    success, otvet, tokens_in_answer = ask_gpt(PROMPT)
    if success:
        bot.send_message(chat_id, f"<b>{otvet}</b>",
                         parse_mode='html',reply_markup=helpkey)
        db.update_history(otvet, chat_id)
        db.update_tokens(tokens_in_answer, chat_id)
@bot.message_handler(commands=['travel_help'])
def travel_help(message):
    chat_id = message.chat.id

    status_check_users, error_message = check_number_of_users(chat_id)
    if not status_check_users:
        bot.send_message(chat_id, error_message)
        return

    city = db.get_city(chat_id)
    if city == None:
        bot.send_message(chat_id, "<b>–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –≥–æ—Ä–æ–¥, –Ω–∞–ø–∏—à–∏—Ç–µ /set_town!</b>üò•\n",
                     parse_mode='html',reply_markup=menu)
        return
    bot.send_message(chat_id, f'–í—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥: {city}')

    PROMPT = [{'role': 'system', 'text': f'–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫ –∏ –±—ã–ª –≤–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–∞—Ö –º–∏—Ä–∞. –†–∞—Å—Å–∫–∞–∂–∏ –æ –≥–ª–∞–≤–Ω—ã—Ö –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö –≤ –≥–æ—Ä–æ–¥–µ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º {city}. –ù–∞–ø–∏—à–∏ —ç—Ç–æ—Ç —Ä–∞—Å—Å–∫–∞–∑ –Ω–µ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 1000 —Å–∏–º–≤–æ–ª–æ–≤. –í –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞–π –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–æ–π –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–µ–±—è.'}]
    user_tokens = db.get_tokens(chat_id)
    if user_tokens < 200:
        bot.send_message(chat_id, "<b>–£ –≤–∞—Å –Ω–µ—Ç—É —Ç–æ–∫–µ–Ω–æ–≤.</b>üò•\n"
                                  "–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã: /help, /get_weather –∏ /support_of_—Åreators",
                     parse_mode='html',reply_markup=menu)
        return
    success, otvet, tokens_in_answer = ask_gpt(PROMPT)
    if success:
        bot.send_message(chat_id, f"<b>{otvet}</b>",
                         parse_mode='html',reply_markup=travelhelp)
        db.update_answer(otvet, chat_id)
        db.update_tokens(tokens_in_answer, chat_id)
@bot.message_handler(commands=['continue'])
def promtcontinue(message):
    chat_id = message.chat.id

    status_check_users, error_message = check_number_of_users(chat_id)
    if not status_check_users:
        bot.send_message(chat_id, error_message)
        return

    last_answer = db.get_answer(chat_id)
    city = db.get_city(chat_id)

    if city == None:
        bot.send_message(chat_id, "<b>–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –≥–æ—Ä–æ–¥, –Ω–∞–ø–∏—à–∏—Ç–µ /set_town!</b>üò•\n",
                     parse_mode='html',reply_markup=menu)
        return

    PROMPT = [{'role': 'system',
               'text': f'–¢–≤–æ–π –ø—Ä–æ—à–ª—ã–π –æ—Ç–≤–µ—Ç: {last_answer}. –Ω–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–æ–π –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–µ–±—è. –ü—Ä–æ–¥–æ–ª–∂–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑ –ø—Ä–æ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥–æ—Ä–æ–¥–∞ {city} –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ —Å–∞–º—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—Å–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥–æ—Ä–æ–¥–∞ {city}. –í –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞–π –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–æ–π –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–µ–±—è.'}]
    user_tokens = db.get_tokens(chat_id)
    if user_tokens < 200:
        bot.send_message(chat_id, "<b>–£ –≤–∞—Å –Ω–µ—Ç—É —Ç–æ–∫–µ–Ω–æ–≤.</b>üò•\n"
                                  "–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã: /help, /get_weather –∏ /support_of_—Åreators",
                         parse_mode='html', reply_markup=menu)
        return
    success, otvet, tokens_in_answer = ask_gpt(PROMPT)
    if success:
        bot.send_message(chat_id, f"<b>{otvet}</b>",
                         parse_mode='html', reply_markup=travelhelp)
        db.update_answer(otvet, chat_id)
        db.update_tokens(tokens_in_answer, chat_id)


####################################################FunctionsModule##########################################################
def set_country(message):
    chat_id = message.chat.id
    country = message.text
    town = db.get_city(chat_id)
    user_name = message.from_user.first_name
    tokens = db.get_tokens(chat_id)
    score = db.get_score(chat_id)
    if town in ['/set_town', '/travel_help', '/town_history', '/help', '/support_of_creators', '/set_country',
                '/interesting_facts']:
        bot.send_message(chat_id, '–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –≤–∞–º —Å—Ç–æ–∏—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –≥–æ—Ä–æ–¥. /set_town', reply_markup=menu)
        return
    else:
        db.update_country(country, chat_id)
        bot.send_message(chat_id, f'–í—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏ –≥–æ—Ä–æ–¥!\n'
                                  f'–í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞:\n'
                                  f'–ò–º—è: {user_name}\n'
                                  f'–ß–∞—Ç_–∞–π–¥–∏: {chat_id}\n'
                                  f'–ì–æ—Ä–æ–¥: {town}\n'
                                  f'–ö–æ–ª-–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: {tokens}\n'
                                  f'–ò–Ω—Ç–µ—Ä–µ—Å—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∞: {country}\n'
                                  f'–ö–æ–ª-–≤–æ –±–∞–ª–ª–æ–≤: {score}', reply_markup=helpkey)
        return
def handle_message(message):
    town = message.text
    user_name = message.from_user.first_name
    chat_id = message.chat.id
    tokens = db.get_tokens(chat_id)
    score = db.get_score(chat_id)
    country = db.get_country(chat_id)
    if town in ['/set_town', '/travel_help', '/town_history', '/help', '/support_of_creators', '/set_country', '/interesting_facts']:
        bot.send_message(chat_id, '–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –≤–∞–º —Å—Ç–æ–∏—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –≥–æ—Ä–æ–¥. /set_town', reply_markup=menu)
        return
    else:
        db.update_city(town, chat_id)
        bot.send_message(chat_id, f'–í—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏ –≥–æ—Ä–æ–¥!\n'
                                  f'–í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞:\n'
                                  f'–ò–º—è: {user_name}\n'
                                  f'–ß–∞—Ç_–∞–π–¥–∏: {chat_id}\n'
                                  f'–ì–æ—Ä–æ–¥: {town}\n'
                                  f'–ö–æ–ª-–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: {tokens}\n'
                                  f'–ò–Ω—Ç–µ—Ä–µ—Å—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∞: {country}\n'
                                  f'–ö–æ–ª-–≤–æ –±–∞–ª–ª–æ–≤: {score}', reply_markup=helpkey)
        return


###################################################TravelQuizModule#########################################################

questions = {
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ë–æ–ª—å—à–∏–º —è–±–ª–æ–∫–æ–º?": ["–ù—å—é-–ô–æ—Ä–∫", "–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å", "–¢–æ–∫–∏–æ"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≠–π—Ñ–µ–ª–µ–≤–∞ –±–∞—à–Ω—è?": ["–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω", "–†–∏–º"],
    "–°—Ç–æ–ª–∏—Ü–µ–π –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω—ã —è–≤–ª—è–µ—Ç—Å—è –ë–µ—Ä–ª–∏–Ω?": ["–ì–µ—Ä–º–∞–Ω–∏—è", "–§—Ä–∞–Ω—Ü–∏—è", "–ò—Ç–∞–ª–∏—è"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –ö–æ–ª–∏–∑–µ–π?": ["–†–∏–º", "–ê—Ñ–∏–Ω—ã", "–ö–∞–∏—Ä"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –º–æ—Å—Ç–æ–≤?": ["–í–µ–Ω–µ—Ü–∏—è", "–ê–º—Å—Ç–µ—Ä–¥–∞–º", "–ü—Ä–∞–≥–∞"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å—Ç–∞—Ç—É—è –•—Ä–∏—Å—Ç–∞-–ò—Å–∫—É–ø–∏—Ç–µ–ª—è?": ["–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ", "–ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å", "–õ–∏–º–∞"],
    "–°—Ç–æ–ª–∏—Ü–µ–π –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω—ã —è–≤–ª—è–µ—Ç—Å—è –ú–æ—Å–∫–≤–∞?": ["–†–æ—Å—Å–∏—è", "–£–∫—Ä–∞–∏–Ω–∞", "–ë–µ–ª–∞—Ä—É—Å—å"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è –≥–æ—Ä–∞ –≤ –º–∏—Ä–µ?": ["–ö–∞—Ç–º–∞–Ω–¥—É", "–ü–µ–∫–∏–Ω", "–î–µ–ª–∏"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –∫–∞–Ω–∞–ª–æ–≤?": ["–ê–º—Å—Ç–µ—Ä–¥–∞–º", "–í–µ–Ω–µ—Ü–∏—è", "–ë—Ä—é–≥–≥–µ"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –ë—É–∫–∏–Ω–≥–µ–º—Å–∫–∏–π –¥–≤–æ—Ä–µ—Ü?": ["–õ–æ–Ω–¥–æ–Ω", "–ü–∞—Ä–∏–∂", "–ú–∞–¥—Ä–∏–¥"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ —è–≤–ª—è–µ—Ç—Å—è –∫—Ä—É–ø–Ω–µ–π—à–∏–º –ø–æ –ø–ª–æ—â–∞–¥–∏ –≤ –º–∏—Ä–µ?": ["–ù—å—é-–ô–æ—Ä–∫", "–¢–æ–∫–∏–æ", "–®–∞–Ω—Ö–∞–π"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –≤–µ—Ç—Ä–æ–≤?": ["–ß–∏–∫–∞–≥–æ", "–õ–æ–Ω–¥–æ–Ω", "–ü–∞—Ä–∏–∂"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –º—É–∑–µ–π –≤ –º–∏—Ä–µ?": ["–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω", "–í–∞—à–∏–Ω–≥—Ç–æ–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç–æ–ª–∏—Ü–µ–π —Å–∞–º–æ–π –º–∞–ª–µ–Ω—å–∫–æ–π —Å—Ç—Ä–∞–Ω—ã –≤ –º–∏—Ä–µ?": ["–í–∞—Ç–∏–∫–∞–Ω", "–ú–æ–Ω–∞–∫–æ", "–°–∞–Ω-–ú–∞—Ä–∏–Ω–æ"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è –±–∞—à–Ω—è –≤ –º–∏—Ä–µ?": ["–î—É–±–∞–π", "–¢–æ–∫–∏–æ", "–®–∞–Ω—Ö–∞–π"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –∞–Ω–≥–µ–ª–æ–≤?": ["–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å", "–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –ø–ª–æ—â–∞–¥—å –≤ –º–∏—Ä–µ?": ["–ü–µ–∫–∏–Ω", "–ú–æ—Å–∫–≤–∞", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º—ã–º –≥—É—Å—Ç–æ–Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–º –≤ –º–∏—Ä–µ?": ["–¢–æ–∫–∏–æ", "–®–∞–Ω—Ö–∞–π", "–î–µ–ª–∏"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –≤ –º–∏—Ä–µ?": ["–û–∫—Å—Ñ–æ—Ä–¥", "–ö–µ–º–±—Ä–∏–¥–∂", "–ë–æ–ª–æ–Ω—å—è"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º —Å–µ–º–∏ —Ö–æ–ª–º–æ–≤?": ["–†–∏–º", "–°—Ç–∞–º–±—É–ª", "–õ–∏—Å—Å–∞–±–æ–Ω"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –ø–æ—Ä—Ç –≤ –º–∏—Ä–µ?": ["–®–∞–Ω—Ö–∞–π", "–°–∏–Ω–≥–∞–ø—É—Ä", "–î—É–±–∞–π"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –í–æ—Å—Ç–æ—á–Ω–æ–π –í–µ–Ω–µ—Ü–∏–µ–π?": ["–°—É—á–∂–æ—É", "–í–µ–Ω–µ—Ü–∏—è", "–ê–º—Å—Ç–µ—Ä–¥–∞–º"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –∞–∫–≤–∞—Ä–∏—É–º –≤ –º–∏—Ä–µ?": ["–ê—Ç–ª–∞–Ω—Ç–∞", "–î—É–±–∞–π", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º —Ç—ã—Å—è—á–∏ —Ö—Ä–∞–º–æ–≤?": ["–ö–∏–æ—Ç–æ", "–ë–∞–Ω–≥–∫–æ–∫", "–õ—å–≤–æ–≤"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –Ω–µ–±–æ—Å–∫—Ä–µ–± –≤ –º–∏—Ä–µ?": ["–î—É–±–∞–π", "–®–∞–Ω—Ö–∞–π", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –º—É–∑—ã–∫–∏?": ["–í–µ–Ω–∞", "–ü–∞—Ä–∏–∂", "–ù—å—é-–ô–æ—Ä–∫"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤ –º–∏—Ä–µ?": ["–í–∞—à–∏–Ω–≥—Ç–æ–Ω", "–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –æ–≥–Ω–µ–π?": ["–ü–∞—Ä–∏–∂", "–õ–∞—Å-–í–µ–≥–∞—Å", "–î—É–±–∞–π"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –ø–∞—Ä–∫ –≤ –º–∏—Ä–µ?": ["–ù—å—é-–ô–æ—Ä–∫", "–õ–æ–Ω–¥–æ–Ω", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –ª—é–±–≤–∏?": ["–ü–∞—Ä–∏–∂", "–í–µ–Ω–∞", "–†–∏–º"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Å—Ç–∞–¥–∏–æ–Ω –≤ –º–∏—Ä–µ?": ["–ü—Ö–µ–Ω—å—è–Ω", "–ë–∞—Ä—Å–µ–ª–æ–Ω–∞", "–õ–æ–Ω–¥–æ–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –Ω–µ–±–æ—Å–∫—Ä–µ–±–æ–≤?": ["–ù—å—é-–ô–æ—Ä–∫", "–¢–æ–∫–∏–æ", "–î—É–±–∞–π"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –≤ –º–∏—Ä–µ?": ["–î—É–±–∞–π", "–ü–µ–∫–∏–Ω", "–®–∞–Ω—Ö–∞–π"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–≤?": ["–ú—É–º–±–∞–∏", "–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ", "–°—Ç–∞–º–±—É–ª"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –æ–∫–µ–∞–Ω–∞—Ä–∏—É–º –≤ –º–∏—Ä–µ?": ["–ê—Ç–ª–∞–Ω—Ç–∞", "–î—É–±–∞–π", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –∫—É–ª—å—Ç—É—Ä—ã?": ["–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω", "–í–µ–Ω–∞"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –º—É–∑–µ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –≤ –º–∏—Ä–µ?": ["–ù—å—é-–ô–æ—Ä–∫", "–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –≤–µ—á–Ω–æ–π –≤–µ—Å–Ω—ã?": ["–ö—É–Ω—å–º–∏–Ω", "–ú–µ—Ö–∏–∫–æ", "–ú–∞–¥—Ä–∏–¥"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —É–ª–∏—Ü–∞ –≤ –º–∏—Ä–µ?": ["–¢–æ—Ä–æ–Ω—Ç–æ", "–õ–æ–Ω–¥–æ–Ω", "–ü–∞—Ä–∏–∂"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –º–æ–¥—ã?": ["–ü–∞—Ä–∏–∂", "–ú–∏–ª–∞–Ω", "–õ–æ–Ω–¥–æ–Ω"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –∑–æ–æ–ø–∞—Ä–∫ –≤ –º–∏—Ä–µ?": ["–°–∞–Ω-–î–∏–µ–≥–æ", "–õ–æ–Ω–¥–æ–Ω", "–ü–µ–∫–∏–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π?": ["–¢–æ–∫–∏–æ", "–°–∞–Ω-–§—Ä–∞–Ω—Ü–∏—Å–∫–æ", "–®–∞–Ω—Ö–∞–π"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –±–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥ –≤ –º–∏—Ä–µ?": ["–õ–æ–Ω–¥–æ–Ω", "–ü–∞—Ä–∏–∂", "–ë–µ—Ä–ª–∏–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –º—É–∑–µ–µ–≤?": ["–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω", "–í–∞—à–∏–Ω–≥—Ç–æ–Ω"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –∫–æ–ª–µ—Å–æ –æ–±–æ–∑—Ä–µ–Ω–∏—è –≤ –º–∏—Ä–µ?": ["–î—É–±–∞–π", "–õ–æ–Ω–¥–æ–Ω", "–õ–∞—Å-–í–µ–≥–∞—Å"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –∏—Å–∫—É—Å—Å—Ç–≤–∞?": ["–§–ª–æ—Ä–µ–Ω—Ü–∏—è", "–ü–∞—Ä–∏–∂", "–í–µ–Ω–∞"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–∫ –≤ –º–∏—Ä–µ?": ["–û—Ä–ª–∞–Ω–¥–æ", "–¢–æ–∫–∏–æ", "–®–∞–Ω—Ö–∞–π"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –∏—Å—Ç–æ—Ä–∏–∏?": ["–†–∏–º", "–°—Ç–∞–º–±—É–ª", "–ê—Ñ–∏–Ω—ã"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –æ–∫–µ–∞–Ω–∞—Ä–∏—É–º –≤ –º–∏—Ä–µ?": ["–ê—Ç–ª–∞–Ω—Ç–∞", "–î—É–±–∞–π", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ–π?": ["–≠–¥–∏–Ω–±—É—Ä–≥", "–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ", "–ù–æ—Ç—Ç–∏–Ω–≥-–•–∏–ª–ª"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –∞–∫–≤–∞–ø–∞—Ä–∫ –≤ –º–∏—Ä–µ?": ["–î—É–±–∞–π", "–û—Ä–ª–∞–Ω–¥–æ", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –ø–ª—è–∂–µ–π?": ["–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ", "–ú–∞–π–∞–º–∏", "–ë–∞—Ä—Å–µ–ª–æ–Ω–∞"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –ø–∞—Ä–∫ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π –≤ –º–∏—Ä–µ?": ["–û—Ä–ª–∞–Ω–¥–æ", "–ü–∞—Ä–∏–∂", "–¢–æ–∫–∏–æ"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –≥–æ—Ä?": ["–ö–µ–π–ø—Ç–∞—É–Ω", "–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ", "–°–∞–Ω-–§—Ä–∞–Ω—Ü–∏—Å–∫–æ"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è –≥–æ—Ä–∞ –≤ –º–∏—Ä–µ?": ["–ö–∞—Ç–º–∞–Ω–¥—É", "–ü–µ–∫–∏–Ω", "–î–µ–ª–∏"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –¥–æ–∂–¥–µ–π?": ["–õ–æ–Ω–¥–æ–Ω", "–°–∏—ç—Ç–ª", "–í–∞–Ω–∫—É–≤–µ—Ä"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –≤–æ–¥–æ–ø–∞–¥ –≤ –º–∏—Ä–µ?": ["–í–∏–∫—Ç–æ—Ä–∏—è", "–ù–∏–∞–≥–∞—Ä—Å–∫–∏–π", "–ò–≥—É–∞—Å—É"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º —Ç—É–º–∞–Ω–æ–≤?": ["–°–∞–Ω-–§—Ä–∞–Ω—Ü–∏—Å–∫–æ", "–õ–æ–Ω–¥–æ–Ω", "–ê–º—Å—Ç–µ—Ä–¥–∞–º"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —Ä–µ–∫–∞ –≤ –º–∏—Ä–µ?": ["–ö–∞–∏—Ä", "–•–∞—Ä—Ç—É–º", "–ê—Å—É–∞–Ω"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –ø—É—Å—Ç—ã–Ω—å?": ["–î—É–±–∞–π", "–ö–∞–∏—Ä", "–õ–∞—Å-–í–µ–≥–∞—Å"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –ª–µ—Å –≤ –º–∏—Ä–µ?": ["–ê–º–∞–∑–æ–Ω–∫–∞", "–ö–æ–Ω–≥–æ", "–¢–∞–π–≥–∞"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –¥–∂—É–Ω–≥–ª–µ–π?": ["–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ", "–ö–∏–Ω—à–∞—Å–∞", "–ú–∞–Ω–∞—É—Å"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –æ—Å—Ç—Ä–æ–≤ –≤ –º–∏—Ä–µ?": ["–ì—Ä–µ–Ω–ª–∞–Ω–¥–∏—è", "–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä", "–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –≤—É–ª–∫–∞–Ω–æ–≤?": ["–ù–µ–∞–ø–æ–ª—å", "–ö–∏–æ—Ç–æ", "–ü–æ—Ä—Ç–ª–µ–Ω–¥"],
    "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –≥–µ–π–∑–µ—Ä –≤ –º–∏—Ä–µ?": ["–ô–µ–ª–ª–æ—É—Å—Ç–æ—É–Ω", "–î–æ–ª–∏–Ω–∞ –≥–µ–π–∑–µ—Ä–æ–≤", "–ò—Å–ª–∞–Ω–¥–∏—è"],
    "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –Ω–∞–∑—ã–≤–∞—é—Ç –ì–æ—Ä–æ–¥–æ–º –≥–µ–π–∑–µ—Ä–æ–≤?": ["–î–æ–ª–∏–Ω–∞ –≥–µ–π–∑–µ—Ä–æ–≤", "–ô–µ–ª–ª–æ—É—Å—Ç–æ—É–Ω", "–ò—Å–ª–∞–Ω–¥–∏—è"]
}

def generate_quiz():
    # –í—ã–±—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    question = random.choice(list(questions.keys()))
    # –ü–æ–ª—É—á–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    answers = questions[question]
    # –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    random.shuffle(answers)
    return question, answers


def check_answer(question, text):
    correct_answer = questions[question][0]
    print(correct_answer)
    return text == correct_answer

@bot.message_handler(commands=['travel_quiz'])
def start_quiz(message):
    global question
    chat_id = message.chat.id
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    bot.send_message(chat_id, text="–î–∞–≤–∞–π –ø–æ–∏–≥—Ä–∞–µ–º –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø—Ä–æ –≥–æ—Ä–æ–¥–∞ –º–∏—Ä–∞.")

    # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
    question, answers = generate_quiz()

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    bot.send_message(chat_id, text=question)
    for answer in answers:
        keyboard.add(KeyboardButton(answer))
    bot.send_message(chat_id,'–í–∞—à –æ—Ç–≤–µ—Ç: ', reply_markup=keyboard)
    bot.register_next_step_handler(message, handle_message_for_quiz)

def handle_message_for_quiz(message):
    chat_id = message.chat.id
    score = db.get_score(chat_id)
    text = message.text
    print(text)

    if text in questions[question]:
        correct = check_answer(question, text)

        if correct:
            bot.send_message(chat_id, text="–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –°—ã–≥—Ä–∞–µ–º —Å–Ω–æ–≤–∞?\n –î–ª—è –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞–∂–º–∏ /travel_quiz", reply_markup=helpkey)
            db.update_score(score+2, chat_id)
        else:
            bot.send_message(chat_id, f"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {questions[text][0]}.  –°—ã–≥—Ä–∞–µ–º —Å–Ω–æ–≤–∞?\n –î–ª—è –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞–∂–º–∏ /travel_quiz", reply_markup=helpkey)

    else:
        bot.send_message(chat_id, text="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å, –≤—ã–±—Ä–∞–≤ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")


bot.polling()